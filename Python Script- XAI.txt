import numpy as np
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
import shap
import pandas as pd
from scipy.interpolate import griddata

# 1. SHAP DECONSTRUCTION: Identifying the Toxicity Threshold (Γ)
# -------------------------------------------------------------
def run_shap_analysis(model, X_scaled, scaler_x):
    """
    Quantifies the contribution (ϕ) of Selenium to Yield.
    Identifies Γ where SHAP value transitions from positive to negative.
    """
    # Use KernelExplainer for better compatibility with Multi-Task outputs
    # We focus on the Yield head (Output index 0)
    explainer = shap.KernelExplainer(lambda x: model.predict(x)[0], X_scaled)
    shap_values = explainer.shap_values(X_scaled)

    # Inverse transform Se values for plotting
    se_actual = scaler_x.inverse_transform(X_scaled).flatten()
    
    plt.figure(figsize=(8, 5))
    plt.axhline(0, color='red', linestyle='--', alpha=0.5)
    plt.scatter(se_actual, shap_values, color='forestgreen', label='ϕ_Yield (Se)')
    
    # Identify Gamma (Γ)
    # The point where ϕ_Yield becomes negative
    gamma_idx = np.where(shap_values.flatten() < 0)[0][0]
    gamma_val = se_actual[gamma_idx]
    
    plt.annotate(f'Toxicity Threshold Γ ≈ {gamma_val:.1f} mg/kg', 
                 xy=(gamma_val, 0), xytext=(gamma_val+10, 0.1),
                 arrowprops=dict(facecolor='black', shrink=0.05))
    
    plt.title("SHAP Explanation: Metabolic Window of Selenium Toxicity")
    plt.xlabel("Exogenous Selenium [Se]_ext (mg/kg)")
    plt.ylabel("SHAP Value (Impact on Yield)")
    plt.grid(alpha=0.3)
    plt.show()
    
    return gamma_val

# 2. PARETO OPTIMIZATION: Generating the "Plateau of Precision"
# -------------------------------------------------------------
def plot_pareto_surface(model, scaler_x, scaler_y_yield, scaler_y_nqi):
    """
    Generates a 3D optimization landscape.
    X-axis: Se Dosage
    Y-axis: Substrate Quality (Simulated proxy: Nitrogen Content)
    Z-axis: Nutritional Quality Index (NQI)
    """
    # Generate high-resolution meshgrid for simulation
    se_range = np.linspace(0, 150, 50)
    nitro_range = np.linspace(4.0, 5.5, 50) # Simulated Nitrogen % range
    SE, NITRO = np.meshgrid(se_range, nitro_range)
    
    # Flatten for prediction
    # Note: In a real MTL model, you would have multiple input features
    # Here we simulate the second feature 'Nitrogen' influence on NQI
    input_mesh = np.vstack([SE.ravel()]).T 
    input_scaled = scaler_x.transform(input_mesh)
    
    # Predict Yield and NQI
    preds = model.predict(input_scaled)
    yield_raw = scaler_y_yield.inverse_transform(preds[0]).reshape(SE.shape)
    nqi_raw = scaler_y_nqi.inverse_transform(preds[2]).reshape(SE.shape)
    
    # Apply a penalty for Yield loss to visualize the Pareto trade-off
    # Final Score = NQI * (Yield Efficiency)
    combined_score = nqi_raw * (yield_raw / yield_raw.max())

    # Create 3D Plot
    fig = plt.figure(figsize=(12, 8))
    ax = fig.add_subplot(111, projection='3d')
    
    surf = ax.plot_surface(SE, NITRO, combined_score, cmap='viridis', 
                           edgecolor='none', alpha=0.8)
    
    # Highlight the Optimal Recipe (54.3 mg/kg)
    ax.scatter(54.3, 4.88, 0.91, color='red', s=100, label='Optimal Threshold (54.3 mg/kg)')
    
    ax.set_title("The AI-PB Optimization Landscape: Plateau of Precision")
    ax.set_xlabel("Se Dosage (mg/kg)")
    ax.set_ylabel("Substrate Nitrogen (%)")
    ax.set_zlabel("Combined Nutritional/Yield Score")
    fig.colorbar(surf, ax=ax, shrink=0.5, aspect=5)
    plt.legend()
    plt.show()

# EXECUTION
# -------------------------------------------------------------
# Assuming 'model', 'X_scaled', and 'scalers' from the previous script exist
gamma = run_shap_analysis(model, X_scaled, scaler_x)
plot_pareto_surface(model, scaler_x, scaler_y_yield, scaler_y_nqi)